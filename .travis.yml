sudo: required

language: python
python:
  - "2.7"
  - "3.5"
  - "3.6"
  - "3.7"
  - "3.8"

stages:
  - test
  - deploy

install:
  - python -V
  - pip install -r requirements.txt

script:
  - git --no-pager diff --check `git log --oneline | tail -1 | cut --fields=1 --delimiter=' '`
  - flake8
  - py.test -vv --cov-config .coveragerc --cov geolink_formatter tests

after_success:
  - bash <(curl -s https://codecov.io/bash)

jobs:
  include:

    - name: "Test documentation"
      python: '3.6'
      stage: test
      if: type = pull_request
      before_script:
        - python -V
        - pip install -r requirements.txt
      script:
        - sphinx-versioning build doc/source doc/build/html

    - name: "Deploy pages for master"
      python: '3.6'
      stage: deploy
      if: branch = master AND NOT type = pull_request
      before_deploy:
        - python -V
        - pip install -r requirements.txt
        - sphinx-versioning build doc/source doc/build/html
        - touch doc/build/html/.nojekyll
      deploy:
        - provider: pages
          skip-cleanup: true
          github-token: $GITHUB_TOKEN
          local-dir: doc/build/html

    - name: "Deploy pages for tag"
      python: '3.6'
      stage: deploy
      if: tag IS present AND NOT type = pull_request
      before_deploy:
        - python -V
        - pip install -r requirements.txt
        - sphinx-versioning build doc/source doc/build/html
        - touch doc/build/html/.nojekyll
      deploy:
        - provider: pages
          skip-cleanup: true
          github-token: $GITHUB_TOKEN
          local-dir: doc/build/html

    - name: "Deploy to PyPI"
      python: '3.6'
      stage: deploy
      if: tag IS present AND NOT type = pull_request
      before_deploy:
        - python -V
        - pip install -r requirements.txt
      deploy:
        - provider: pypi
          server: https://upload.pypi.org/legacy/
          user: "__token__"
          password:
            secure: "GMEYi6Hnel7JcvKBXPcAl8POV53Vu7dirbGOj3DNRRl7pqMvVSjerSeoPIw0jc69eE4FFqmhALiTlPGif2D2QRDtruB8gTHxVrUOtd+vxzNiEMBzrNMuj2LcSJiQIEAtpTKRmRNXYS09Xu+qrGBvXJyZ6ECRVSxm8hwCY8xbhdhc+astETN1w6VbefeDkPqThl0zfJHQLC/6y0BtzARom5h5aKXY5OAogmkwI5p6KW6qMjcEfCZXgXj3PgVa6fOHdO3TMCacgtkEKu7vt1XiJpGyNPBFxI6D7N60LwPck0sl5g0A7ZbmBZGVLxlh5iFRqyJtxnVV8PNFULDi9Dma4epjTZ0I2BocGyXhtKpWvPSvcT3CevetqlQKgHSoQY2qN0me3tu8aDZ2wIOcTt54zzbtaLYNF2nPSaCjfUWgsiWj6V4sXuypa4RY4UXQjn7N6PWR+Y0+b7m1HrZm6KEKfYtwFdQ/JaX2eumcHE4UAGaw0zxYKa6Bg6Gto8eQfpMhlDQ5TaP6n2KU0u/BKIKW2a+9iZK2hpaZtS64IIJIwppZjeMiHjT1VggACsdYzaZNRWpW2VBgRCPLvJ+guM4P80QCB3Ewo6In4OSHsFteQIV3RzgpgyRyaaPOSR3KEW9OJIA/QYDlYPIuClbAEWh15VTGeoMTEq6HX6b6zuff8pQ="
          distributions: "sdist bdist_wheel"
          skip_upload_docs: true
          skip_cleanup: true
          on:
            tags: true
            repo: openoereb/geolink_formatter
            python: '3.6'

    - name: "Deploy to PyPI Test"
      python: '3.6'
      stage: deploy
      if: branch = master AND NOT type = pull_request
      before_deploy:
        - python -V
        - pip install -r requirements.txt
        - sed -i "s/\(version='[0-9]*\.[0-9]*\.[0-9]*\)\('\)/\1-dev.$(date +%Y%m%d%H%M%S)\2/g" setup.py
        - sed -i "s/5 - Production\/Stable/4 - Beta/g" setup.py
      deploy:
        - provider: pypi
          server: https://test.pypi.org/legacy/
          user: "__token__"
          password:
            secure: "K4gnV3fYansoUv9NbkWlHfoWIqck7WJ248M9jGacl2lsf/TKVWGpguDcqB2mqp468f/YSlwjD+bwPzBE/nDXlqbc6TfaVOFpZbohykQ8hgwptaMNGEl99+UD5w/FTIzncJT6NxmY1pogiN3CLR7674Qcc/DvY9rZYMMJrGgc7U+kmRhGko7HRY4Vlym5ImVGH2CIiOk2BKPih7w9yvB5fljYbMQQ5GM6GFPtGTL41eMFw6HP1zwf69SM4Fp4NNcTNDcemv9USdHBfcyhiP5Oep/s7I+NAbxtG5BtskrdMECq56btYs2U5hBl7fl3uwxcEhYlCZSncFhwwi/+8nwu4ZXpVxESEcL3FMccpw/ULrsDawZCc7mWu8PDDVxDNa5x3vA415TPaKMpj2jPqkhf7zKiMNUR6uEdZUFbtAlR0VWHtPcpj9gGYSUHTKnCgy8wlFio2446uPy1yQiJyg/+BJmyWtuccX3LHd0FjwKnDeCqnkV5116BzMFz5/GFl+3/RPjntPWoHWKQOuIvVZxvrKBMWuvnJ/NEuA6tO4G0pXHHt0ZhvgRb2wmV78sbkWgNWZUjGPmjJqH4nqMOLWqDYOakNrQW52K1Pv2x3nxoN04ovDvs0tE96/Xfa4uufBFN61M0wURraqJmhzqdivcE8gytnC0A8nhuuihUZ6RLcls="
          distributions: "sdist bdist_wheel"
          skip_upload_docs: true
          skip_cleanup: true
